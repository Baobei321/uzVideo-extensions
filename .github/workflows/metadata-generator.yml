name: Metadata JSON Generator

on:
  push:
  workflow_dispatch:

jobs:
  generate-metadata:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    - name: Generate Metadata
      run: |
        node action/parse-metadata.cjs

    - name: Commit changes
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add README.md
        git commit -m '该文件自动生成，无需手动修改。' || echo 'No changes to commit'
        git push


    - name: 🚀 Upload JSON to GitHub Release
      uses: ncipollo/release-action@v1.18.0
      with:
        tag: uzVideo-Extensions-${{ github.ref_name }}   # 根据分支名生成 tag
        name: "uzVideo-Extensions (${{ github.ref_name }})"
        body: "这些文件由 GitHub Actions 在分支 ${{ github.ref_name }} 自动生成。"
        allowUpdates: true
        replacesArtifacts: true
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: |
          uzAio.json
          uzAio_raw.json
          av_auto.json
          av_raw_auto.json
          local.json
          env.json
          README.md
          panTools/panTools.json
          danMu/danMu.json
          recommend/douban.json
          vod/vod.json
          uzAio.zip